version: '3.8'
services:
  nginx:
    image: nginx
    container_name: reverse_proxy
    networks:
     - dbnetwork
    ports:
     - 80:80
     - 443:443
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certbot/www:/var/www/certbot/:ro
      - ./certbot/conf/:/etc/nginx/ssl/:ro
      #These are for testing
      #- ./self_cert.crt:/etc/ssl/certs/self_cert.crt:ro
      #- ./self_signed.key:/etc/ssl/private/self_signed.key:ro

    command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'" #Command to update nginx when new certificates are available


  certbot:
    image: certbot/certbot:latest
    volumes:
      - ./certbot/www/:/var/www/certbot/:rw
      - ./certbot/conf/:/etc/letsencrypt/:rw
    entrypoint: "/bin/sh -c 'certbot certonly --webroot --webroot-path /var/www/certbot/ --non-interactive -d mastapp.site -d www.mastapp.site --agree-tos --register-unsafely-without-email';'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"  #Runs inital certifical generation then attempts to renew certificates every 12 hours (If they don't need to be renewed they are skipped)
    #Above is for production, below is for testing, the difference is that below uses the staging server (So no real certificates are saved) and doesn't try to renew
    #entrypoint: "/bin/sh -c 'certbot certonly --webroot --webroot-path /var/www/certbot/ --non-interactive -d mastapp.site -d www.mastapp.site --agree-tos --register-unsafely-without-email --dry-run'"