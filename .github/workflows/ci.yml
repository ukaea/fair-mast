name: CI
on: [ pull_request ]

jobs:
  build-and-run-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Cache Docker layers
      uses: actions/cache@v2
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Login to DockerHub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and run containers
      run: |
        docker compose \
        --env-file dev/docker/.env.dev \
        -f dev/docker/docker-compose.yml \
        up \
        --build \
        -d 

    - name: Set up environment
      run: |
        git lfs fetch
        git lfs pull
        pip install uv
        uv venv venv
        source venv/bin/activate
        uv pip install -r docs/requirements.txt
  
    - name: Run tests
      run: |
        source venv/bin/activate
        python -m pytest -rsx tests/ --data-path=/home/runner/work/fair-mast/fair-mast/tests/mock_data/index

  ruff-code-check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - uses: chartboost/ruff-action@v1  
